<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CPA Reviewer — AICPA Blueprint Library (auto by filename)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0a1f44;--panel:#0f2a5c;--line:#1e3a7a;--text:#e6efff;--muted:#bcd1ff;--accent:#7fb3ff;--chip:#0c254f}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{padding:18px 22px;font-weight:700;font-size:20px;border-bottom:1px solid var(--line)}
  .app{display:grid;grid-template-columns:420px 1fr;min-height:calc(100vh - 58px)}
  @media (max-width:980px){.app{grid-template-columns:1fr;grid-auto-rows:auto 72vh}}
  .nav{border-right:1px solid var(--line);overflow:auto}
  .section{border-bottom:1px solid var(--line)}
  .section>button{width:100%;text-align:left;padding:14px 16px;background:var(--panel);color:var(--text);border:0;border-bottom:1px solid var(--line);font-weight:700;cursor:pointer}
  .section>button .chev{float:right;opacity:.8}
  .areas{padding:8px 10px 16px;background:linear-gradient(180deg,#0f2a5c,#0b214a)}
  .area{margin:10px 0;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0e2756}
  .area>button{width:100%;text-align:left;background:transparent;color:var(--text);border:0;padding:12px 14px;font-weight:600;cursor:pointer}
  .area>button .chev{float:right;opacity:.8}
  .topics{border-top:1px solid var(--line);padding:10px 12px}
  .topic{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
  .topic:hover{background:rgba(255,255,255,.06)}
  .badge{min-width:26px;height:26px;display:inline-grid;place-items:center;border:1px solid var(--line);border-radius:6px;background:var(--chip);color:var(--accent);font-weight:700;font-size:13px}
  .topic.disabled{opacity:.55;cursor:not-allowed}
  .topic.disabled:hover{background:transparent}
  .topic .open{margin-left:auto;color:var(--accent);font-size:12px;text-decoration:underline}
  .viewer{position:relative;background:var(--panel)}
  .toolbar{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);background:#0d264f;position:sticky;top:0;z-index:2}
  .toolbar .title{font-weight:700}
  .toolbar .muted{color:var(--muted);font-size:13px}
  .toolbar a{color:var(--accent);text-decoration:none}
  .toolbar a:hover{text-decoration:underline}
  iframe{display:block;width:100%;height:calc(100% - 48px);border:0;background:radial-gradient(ellipse at center,#0f2a5c 0,#0a1f44 70%)}
  .empty{padding:30px;color:var(--muted);font-size:14px}
  .controls{display:flex;gap:8px;margin-left:auto}
  .chipBtn{background:transparent;border:1px solid var(--line);color:var(--muted);border-radius:999px;padding:6px 10px;cursor:pointer}
  .chipBtn:hover{border-color:var(--accent);color:var(--accent)}
</style>
</head>
<body>
<header>CPA Reviewer — AICPA Blueprint Library (2025)</header>

<div class="app">
  <nav class="nav" id="nav"></nav>

  <section class="viewer" id="viewer">
    <div class="toolbar">
      <div class="title" id="vTitle">Select a topic on the left</div>
      <span class="muted" id="vPath" style="margin-left:8px"></span>
      <div class="controls">
        <button class="chipBtn" id="expandAll">Expand all</button>
        <button class="chipBtn" id="collapseAll">Collapse all</button>
        <a class="chipBtn" id="openNew" href="#" target="_blank" rel="noopener">Open in new tab</a>
      </div>
    </div>
    <div id="empty" class="empty">Nothing loaded yet.</div>
    <iframe id="frame" title="Lecture viewer" src=""></iframe>
  </section>
</div>

<script>
  /* ===== 1) Set your Firebase Hosting base URL ===== */
  const BASE = "https://cpalectures-c1d1e.web.app/"; // change if you use a custom domain

  /* ===== 2) Optional external manifest =====
     If public/lectures.json exists (array of filenames), this page uses it.
     Otherwise it falls back to FILES below. */
  const FILES = [
    // Example fallbacks — delete/replace as you like:
    "TCP_IV_A_Nontaxable_Dispositions_Reviewer.html",
    "TCP_IV_B_Gains_Losses_Netting_Reviewer.html",
    "TCP_IV_C_Related_Parties_Imputed_Interest_Reviewer.html"
  ];

  /* ===== 3) Section & Area titles from the 2025 blueprint ===== */
  const SECTION_TITLES = {
    AUD:"Auditing & Attestation (AUD)",
    FAR:"Financial Accounting & Reporting (FAR)",
    REG:"Regulation (REG)",
    TCP:"Tax Compliance & Planning (TCP)",
    ISC:"Information Systems & Controls (ISC)",
    BAR:"Business Analysis & Reporting (BAR)"
  };
  const AREA_TITLES = {
    AUD:{ I:"Ethics, Professional Responsibilities & General Principles",
          II:"Assessing Risk & Planning a Response",
          III:"Performing Procedures & Obtaining Evidence",
          IV:"Forming Conclusions & Reporting" },
    FAR:{ I:"Conceptual Framework, Standard-Setting & Reporting",
          II:"Select Financial Statement Accounts",
          III:"Select Transactions",
          IV:"State & Local Governments" },
    REG:{ I:"Ethics & Professional Responsibilities in Tax Practice",
          II:"Business Law",
          III:"Federal Tax Procedures & Accounting Issues",
          IV:"Federal Taxation of Property Transactions",
          V:"Federal Taxation of Individuals",
          VI:"Federal Taxation of Entities" },
    TCP:{ I:"Individuals", II:"Entities", III:"Transactions & Planning", IV:"Property & Netting" },
    ISC:{ I:"IT Governance, Risk & Compliance",
          II:"IT Systems, Data & Security",
          III:"SOC Engagements",
          IV:"Incident Response" },
    BAR:{ I:"Business Processes, Controls & Data",
          II:"Technical Accounting & Reporting",
          III:"Analysis, Forecasting & Performance" }
  };

  /* Optional canonical topic names by area (used if filename tail is empty) */
  const TOPIC_HINTS = {
    TCP:{ IV:{ A:"Nontaxable dispositions of assets",
               B:"Amount & character of gains/losses; netting process",
               C:"Related-party transactions; imputed interest" } }
  };

  /* ===== 4) Parse filenames that match your convention =====
     Supported:
       SEC_AREA_TOPIC_Title.html  (AUD_I_A_Title.html)
       SEC_AREATOPIC_Title.html   (AUD_IA_Title.html)
       SEC_AREA_Title.html        (topic omitted → "—") */
  function parseFileName(name){
    const clean = name.split(/[?#]/)[0];
    let m = clean.match(/^([A-Z]{3})_([IVX]+)_([A-Z])[_-]?(.*)\.html?$/i)
          || clean.match(/^([A-Z]{3})_([IVX]+)([A-Z])[_-]?(.*)\.html?$/i);
    if(!m){
      m = clean.match(/^([A-Z]{3})_([IVX]+)[_-]?(.*)\.html?$/i);
      if(!m) return null;
      const [, sec, area, tail] = m;
      return { section:sec.toUpperCase(), area:toRoman(area), topic:"—",
               title:niceTitle(tail) || "Topic", file:clean };
    }
    const [, sec, area, topic, tail] = m;
    return { section:sec.toUpperCase(), area:toRoman(area),
             topic:topic.toUpperCase(),
             title:niceTitle(tail) || topic.toUpperCase(), file:clean };
  }
  function toRoman(s){
    const up=s.toUpperCase().replace(/[^IVX]/g,"");
    if(["I","II","III","IV","V","VI"].includes(up)) return up;
    if(/^\d+$/.test(s)) return ["","I","II","III","IV","V","VI"][+s] || s;
    return up || s.toUpperCase();
  }
  function niceTitle(t){ return t ? t.replace(/[_\-]+/g," ").replace(/\s+/g," ")
                                      .replace(/\b([a-z])/g,c=>c.toUpperCase()).trim() : ""; }

  function romanValue(r){ const map={I:1,V:5,X:10}; let p=0,t=0; for(let i=r.length-1;i>=0;i--){const v=map[r[i]]||0; t+=v<p?-v:v; p=v;} return t||0; }

  /* ===== 5) Build the library structure from filenames ===== */
  function buildLibrary(filenames){
    const lib={};
    // seed with all sections/areas so empties still show
    Object.entries(AREA_TITLES).forEach(([sec,areas])=>{
      lib[sec]=lib[sec]||{name:SECTION_TITLES[sec]||sec,areas:{}};
      Object.entries(areas).forEach(([rn,areaName])=>{
        lib[sec].areas[rn]=lib[sec].areas[rn]||{name:`Area ${rn} — ${areaName}`,topics:[]};
      });
    });

    filenames.forEach(fn=>{
      const info=parseFileName(fn); if(!info) return;
      const sec=info.section, area=info.area, topic=info.topic;
      lib[sec]=lib[sec]||{name:SECTION_TITLES[sec]||sec,areas:{}};
      const areaName=(AREA_TITLES[sec]&&AREA_TITLES[sec][area])?`Area ${area} — ${AREA_TITLES[sec][area]}`:`Area ${area}`;
      lib[sec].areas[area]=lib[sec].areas[area]||{name:areaName,topics:[]};
      const hint=(TOPIC_HINTS[sec]&&TOPIC_HINTS[sec][area]&&TOPIC_HINTS[sec][area][topic])?TOPIC_HINTS[sec][area][topic]:null;
      const title=info.title && info.title!==info.topic ? info.title : (hint || `Topic ${topic}`);
      lib[sec].areas[area].topics.push({code:topic,title,file:info.file});
    });

    // sort areas and topics
    Object.values(lib).forEach(section=>{
      section.areas=Object.fromEntries(Object.entries(section.areas).sort((a,b)=>romanValue(a[0])-romanValue(b[0])));
      Object.values(section.areas).forEach(area=>{
        area.topics.sort((a,b)=> (a.code==="—")-(b.code==="—") || a.code.localeCompare(b.code));
      });
    });
    return lib;
  }

  /* ===== 6) Render UI ===== */
  const nav=document.getElementById('nav');
  const frame=document.getElementById('frame');
  const vTitle=document.getElementById('vTitle');
  const vPath=document.getElementById('vPath');
  const openNew=document.getElementById('openNew');
  const empty=document.getElementById('empty');
  const el=(t,c,h)=>{const e=document.createElement(t); if(c)e.className=c; if(h!==undefined)e.innerHTML=h; return e;}

  function render(lib){
    nav.innerHTML="";
    Object.entries(lib).forEach(([secCode,secObj])=>{
      const section=el('div','section');
      const sBtn=el('button',null,(secObj.name||secCode)+'<span class="chev">▴</span>');
      const areasWrap=el('div','areas'); // expanded by default
      sBtn.addEventListener('click',()=>{const vis=areasWrap.style.display!=='none'; areasWrap.style.display=vis?'none':'block'; sBtn.querySelector('.chev').textContent=vis?'▾':'▴';});

      Object.entries(secObj.areas).forEach(([roman,areaObj])=>{
        const area=el('div','area');
        const aBtn=el('button',null,(areaObj.name||`Area ${roman}`)+'<span class="chev">▴</span>');
        const tWrap=el('div','topics'); // expanded by default
        aBtn.addEventListener('click',()=>{const vis=tWrap.style.display!=='none'; tWrap.style.display=vis?'none':'block'; aBtn.querySelector('.chev').textContent=vis?'▾':'▴';});

        if(areaObj.topics.length===0){
          const row=el('div','topic disabled');
          row.appendChild(el('span','badge','—'));
          row.appendChild(el('div',null,'No files yet'));
          tWrap.appendChild(row);
        }else{
          areaObj.topics.forEach(t=>{
            const row=el('div','topic');
            row.appendChild(el('span','badge',t.code||'•'));
            row.appendChild(el('div',null,`<div>${t.title}</div>`));
            const url=BASE+t.file;
            const open=el('span','open','open');
            row.appendChild(open);
            row.addEventListener('click',()=>loadLecture(t.title,url,secObj.name,areaObj.name,t.code));
            tWrap.appendChild(row);
          });
        }
        area.appendChild(aBtn); area.appendChild(tWrap); areasWrap.appendChild(area);
      });

      section.appendChild(sBtn); section.appendChild(areasWrap); nav.appendChild(section);
    });

    // auto-load first topic available
    for(const sec of Object.values(lib)){
      for(const area of Object.values(sec.areas)){
        if(area.topics.length){ const t=area.topics[0]; loadLecture(t.title,BASE+t.file,sec.name,area.name,t.code); return; }
      }
    }
  }

  function loadLecture(title,url,sectionName,areaName,code){
    frame.src=url;
    vTitle.textContent=title;
    vPath.textContent=`• ${sectionName} → ${areaName}${code && code!=="—" ? " → "+code : ""}`;
    openNew.href=url;
    empty.style.display='none';
  }
  function expandOrCollapse(show){
    document.querySelectorAll('.areas').forEach(e=>e.style.display=show?'block':'none');
    document.querySelectorAll('.topics').forEach(e=>e.style.display=show?'block':'none');
    document.querySelectorAll('.section>button .chev').forEach(c=>c.textContent=show?'▴':'▾');
    document.querySelectorAll('.area>button .chev').forEach(c=>c.textContent=show?'▴':'▾');
  }
  document.getElementById('expandAll').addEventListener('click',()=>expandOrCollapse(true));
  document.getElementById('collapseAll').addEventListener('click',()=>expandOrCollapse(false));

  /* ===== 7) Start: load manifest (if exists), otherwise use FILES ===== */
  (async function start(){
    let list = FILES.slice();
    try{
      const res = await fetch(BASE + 'lectures.json', {cache:'no-store'});
      if(res.ok){ list = await res.json(); }
    }catch(e){ /* ignore; fallback to FILES */ }
    const lib = buildLibrary(list);
    render(lib);
    expandOrCollapse(true); // show everything by default
  })();
</script>
</body>
</html>

